{% extends "admin/base.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin-settings.css') }}">
{% endblock %}

{% block content %}
<!-- Enhanced Header -->
<div class="admin-header slide-in-up">
    <div class="header-content">
        <div class="header-main">
            <h1><i class="fas fa-cog"></i> Configurações do Site</h1>
            <p class="header-subtitle">Personalize e configure todos os aspectos do seu site</p>
        </div>
        <div class="header-actions">
            <div class="quick-stats">
                <div class="stat-item">
                    <span class="stat-number">{{ site_configs|length }}</span>
                    <span class="stat-label">Configurações</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">5</span>
                    <span class="stat-label">Seções</span>
                </div>
            </div>
            <div class="action-buttons">
                <button class="btn-admin btn-admin-outline" onclick="resetToDefaults()">
                    <i class="fas fa-undo"></i> Restaurar Padrões
                </button>
                <button class="btn-admin btn-admin-success" onclick="previewChanges()">
                    <i class="fas fa-eye"></i> Visualizar
                </button>
                <button class="btn-admin btn-admin-primary" onclick="saveAllSettings()">
                    <i class="fas fa-save"></i> Salvar Alterações
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Redesigned Settings Layout -->
<div class="row">
    <!-- Left Sidebar: Menu and Status -->
    <div class="col-md-3">
        <!-- Settings Menu -->
        <div class="admin-card slide-in-up" style="position: sticky; top: 20px;">
            <div class="admin-card-header">
                <h2 class="admin-card-title">
                    <i class="fas fa-list"></i> Menu
                </h2>
            </div>
            <div class="settings-nav">
                <a href="#general" class="nav-item active" onclick="scrollToSection('general', event)">
                    <i class="fas fa-home"></i>
                    <span>Geral</span>
                </a>
                <a href="#appearance" class="nav-item" onclick="scrollToSection('appearance', event)">
                    <i class="fas fa-palette"></i>
                    <span>Aparência</span>
                </a>
                <a href="#contact" class="nav-item" onclick="scrollToSection('contact', event)">
                    <i class="fas fa-envelope"></i>
                    <span>Contato</span>
                </a>
                <a href="#social" class="nav-item" onclick="scrollToSection('social', event)">
                    <i class="fas fa-share-alt"></i>
                    <span>Redes Sociais</span>
                </a>
                <a href="#advanced" class="nav-item" onclick="scrollToSection('advanced', event)">
                    <i class="fas fa-cogs"></i>
                    <span>Avançado</span>
                </a>
            </div>

            <!-- Quick Status (Moved inside sidebar) -->
            <div class="mt-4 pt-4 border-top">
                <h6 class="text-muted mb-3 px-3">STATUS DO SISTEMA</h6>
                <div class="px-3">
                    <div class="d-flex align-items-center mb-2">
                        <div class="status-indicator success me-2" style="width: 10px; height: 10px; border-radius: 50%; background: #28a745;"></div>
                        <span class="small">Sistema Online</span>
                    </div>
                    {% if site_configs.get('maintenance_mode') %}
                    <div class="d-flex align-items-center mb-2">
                        <div class="status-indicator warning me-2" style="width: 10px; height: 10px; border-radius: 50%; background: #ffc107;"></div>
                        <span class="small">Manutenção Ativa</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Right Content: All Settings Stacked -->
    <div class="col-md-9">
        <div class="settings-content slide-in-up">

            <!-- Section: General -->
            <div class="admin-card mb-4" id="general">
                <div class="admin-card-header">
                    <h2 class="admin-card-title"><i class="fas fa-home me-2"></i> Configurações Gerais</h2>
                </div>
                <div class="admin-card-body">
                    <div class="settings-form">
                        <div class="form-group">
                            <label for="site_name">Nome do Site</label>
                            <input type="text" id="site_name" class="form-control"
                                value="{{ site_configs.get('site_name', 'Mundo da Informática') }}"
                                data-key="site_name" data-type="string">
                            <small class="form-text text-muted">Nome exibido no título das páginas e no cabeçalho</small>
                        </div>
                        <div class="form-group mt-3">
                            <label for="site_description">Descrição do Site</label>
                            <textarea id="site_description" class="form-control" rows="2"
                                    data-key="site_description" data-type="string">{{ site_configs.get('site_description', 'Seu portal de recursos para técnicos de informática') }}</textarea>
                            <small class="form-text text-muted">Descrição usada em meta tags e SEO</small>
                        </div>
                        <div class="form-group mt-3">
                            <label for="footer_text">Texto do Rodapé</label>
                            <input type="text" id="footer_text" class="form-control"
                                value="{{ site_configs.get('footer_text', 'Mundo da Informática - Todos os direitos reservados') }}"
                                data-key="footer_text" data-type="string">
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="home_hero_title">Título Principal (Home)</label>
                                    <input type="text" id="home_hero_title" class="form-control"
                                        value="{{ site_configs.get('home_hero_title', 'Bem-vindo ao Mundo da Informática') }}"
                                        data-key="home_hero_title" data-type="string">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="home_hero_subtitle">Subtítulo (Home)</label>
                                    <input type="text" id="home_hero_subtitle" class="form-control"
                                        value="{{ site_configs.get('home_hero_subtitle', 'Recursos essenciais para técnicos') }}"
                                        data-key="home_hero_subtitle" data-type="string">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section: Appearance -->
            <div class="admin-card mb-4" id="appearance">
                <div class="admin-card-header">
                    <h2 class="admin-card-title"><i class="fas fa-palette me-2"></i> Aparência</h2>
                </div>
                <div class="admin-card-body">
                    <div class="settings-form">
                        <div class="form-group">
                            <label for="enable_dark_mode" class="d-flex align-items-center justify-content-between cursor-pointer">
                                <span>Habilitar Modo Escuro</span>
                                <div class="form-check form-switch">
                                    <input type="checkbox" id="enable_dark_mode" class="form-check-input"
                                        {{ 'checked' if site_configs.get('enable_dark_mode', True) else '' }}
                                        data-key="enable_dark_mode" data-type="bool">
                                </div>
                            </label>
                            <small class="form-text text-muted">Permite aos usuários alternar o tema do site</small>
                        </div>

                        <div class="row mt-4">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Cor Primária</label>
                                    <div class="input-group">
                                        <input type="color" id="primary_color" class="form-control form-control-color color-picker"
                                            value="{{ site_configs.get('primary_color', '#3a86ff') }}"
                                            data-key="primary_color" data-type="string" title="Escolher cor">
                                        <input type="text" id="primary_color_text" class="form-control"
                                            value="{{ site_configs.get('primary_color', '#3a86ff') }}">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Cor Secundária</label>
                                    <div class="input-group">
                                        <input type="color" id="secondary_color" class="form-control form-control-color color-picker"
                                            value="{{ site_configs.get('secondary_color', '#8338ec') }}"
                                            data-key="secondary_color" data-type="string" title="Escolher cor">
                                        <input type="text" id="secondary_color_text" class="form-control"
                                            value="{{ site_configs.get('secondary_color', '#8338ec') }}">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section: Contact -->
            <div class="admin-card mb-4" id="contact">
                <div class="admin-card-header">
                    <h2 class="admin-card-title"><i class="fas fa-envelope me-2"></i> Contato</h2>
                </div>
                <div class="admin-card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="contact_email">Email</label>
                                <input type="email" id="contact_email" class="form-control"
                                    value="{{ site_configs.get('contact_email', 'contato@mundodainformatica.com') }}"
                                    data-key="contact_email" data-type="string">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="contact_phone">Telefone</label>
                                <input type="text" id="contact_phone" class="form-control"
                                    value="{{ site_configs.get('contact_phone', '(00) 1234-5678') }}"
                                    data-key="contact_phone" data-type="string">
                            </div>
                        </div>
                    </div>
                    <div class="form-group mt-3">
                        <label for="contact_address">Endereço</label>
                        <input type="text" id="contact_address" class="form-control"
                                value="{{ site_configs.get('contact_address', 'Av. Tecnologia, 123 - SP') }}"
                                data-key="contact_address" data-type="string">
                    </div>
                </div>
            </div>

            <!-- Section: Social -->
            <div class="admin-card mb-4" id="social">
                <div class="admin-card-header">
                    <h2 class="admin-card-title"><i class="fas fa-share-alt me-2"></i> Redes Sociais</h2>
                </div>
                <div class="admin-card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label><i class="fab fa-facebook me-2"></i> Facebook</label>
                            <input type="url" class="form-control" id="facebook_url"
                                value="{{ site_configs.get('social_links', {}).get('facebook', '') }}"
                                data-social="facebook" placeholder="https://facebook.com/...">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label><i class="fab fa-instagram me-2"></i> Instagram</label>
                            <input type="url" class="form-control" id="instagram_url"
                                value="{{ site_configs.get('social_links', {}).get('instagram', '') }}"
                                data-social="instagram" placeholder="https://instagram.com/...">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label><i class="fab fa-twitter me-2"></i> Twitter</label>
                            <input type="url" class="form-control" id="twitter_url"
                                value="{{ site_configs.get('social_links', {}).get('twitter', '') }}"
                                data-social="twitter" placeholder="https://twitter.com/...">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label><i class="fab fa-youtube me-2"></i> YouTube</label>
                            <input type="url" class="form-control" id="youtube_url"
                                value="{{ site_configs.get('social_links', {}).get('youtube', '') }}"
                                data-social="youtube" placeholder="https://youtube.com/...">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section: Advanced -->
            <div class="admin-card mb-4" id="advanced">
                <div class="admin-card-header">
                    <h2 class="admin-card-title"><i class="fas fa-cogs me-2"></i> Avançado</h2>
                </div>
                <div class="admin-card-body">
                    <div class="form-group">
                        <label for="google_analytics">Google Analytics ID</label>
                        <input type="text" id="google_analytics" class="form-control"
                            value="{{ site_configs.get('google_analytics', '') }}"
                            data-key="google_analytics" data-type="string" placeholder="UA-XXXXX-Y">
                    </div>

                    <div class="form-group mt-3">
                        <label for="maintenance_mode" class="d-flex align-items-center justify-content-between cursor-pointer text-danger">
                            <span><i class="fas fa-tools me-2"></i> Modo de Manutenção</span>
                            <div class="form-check form-switch">
                                <input type="checkbox" id="maintenance_mode" class="form-check-input"
                                    {{ 'checked' if site_configs.get('maintenance_mode', False) else '' }}
                                    data-key="maintenance_mode" data-type="bool">
                            </div>
                        </label>
                        <small class="form-text text-muted">Quando ativo, o site ficará visível apenas para administradores.</small>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function scrollToSection(sectionId, event) {
        event.preventDefault();
        const element = document.getElementById(sectionId);
        const headerOffset = 100;
        const elementPosition = element.getBoundingClientRect().top;
        const offsetPosition = elementPosition + window.pageYOffset - headerOffset;

        window.scrollTo({
            top: offsetPosition,
            behavior: "smooth"
        });

        // Update active class
        document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Highlight active section on scroll
        const sections = document.querySelectorAll('.admin-card[id]');
        const navItems = document.querySelectorAll('.nav-item');

        window.addEventListener('scroll', () => {
            let current = '';
            sections.forEach(section => {
                const sectionTop = section.offsetTop;
                const sectionHeight = section.clientHeight;
                if (pageYOffset >= (sectionTop - 150)) {
                    current = section.getAttribute('id');
                }
            });

            navItems.forEach(nav => {
                nav.classList.remove('active');
                if (nav.getAttribute('href') === '#' + current) {
                    nav.classList.add('active');
                }
            });
        });

        // Preview changes function
        window.previewChanges = function() {
            const previewWindow = window.open('/', '_blank');
            showNotification('Abrindo preview do site em nova aba...', 'info');
        };

        // Reset to defaults function
        window.resetToDefaults = function() {
            if (confirm('Tem certeza que deseja restaurar todas as configurações para os valores padrão? Esta ação não pode ser desfeita.')) {
                // Reset form values to defaults here if needed or reload page with a query param to reset backend side
                // For now, reload
                alert("Para resetar os valores, por favor implemente a rota de reset no backend.");
            }
        };

        // Sincronizar inputs de cor texto/picker
        const colorInputs = document.querySelectorAll('.color-picker');
        colorInputs.forEach(input => {
            const textInput = document.getElementById(`${input.id}_text`);

            if(textInput) {
                input.addEventListener('input', () => {
                    textInput.value = input.value;
                });

                textInput.addEventListener('change', () => {
                    // Validar se é um valor hexadecimal válido
                    const isValidHex = /^#[0-9A-F]{6}$/i.test(textInput.value);
                    if (isValidHex) {
                        input.value = textInput.value;
                    } else {
                        textInput.value = input.value;
                    }
                });
            }
        });

        // Função para salvar configurações
        window.saveAllSettings = function() {
            const settings = {};

            // Coletar valores dos inputs simples
            document.querySelectorAll('[data-key]').forEach(input => {
                const key = input.getAttribute('data-key');
                const type = input.getAttribute('data-type');

                let value;
                if (input.type === 'checkbox') {
                    value = input.checked;
                } else {
                    value = input.value;
                }

                settings[key] = {
                    value: value,
                    type: type
                };
            });

            // Coletar valores das redes sociais
            const socialLinks = {};
            document.querySelectorAll('[data-social]').forEach(input => {
                const network = input.getAttribute('data-social');
                socialLinks[network] = input.value;
            });

            settings['social_links'] = {
                value: socialLinks,
                type: 'json'
            };

            // Enviar para o servidor via fetch API
            fetch('/admin/save_settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(settings)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Configurações salvas com sucesso!', 'success');
                } else {
                    showNotification('Erro ao salvar configurações.', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Erro ao salvar configurações.', 'error');
            });
        };

        // Função para mostrar notificações
        function showNotification(message, type) {
            // Check if toast container exists
            let container = document.querySelector('.toast-container');
            if (!container) {
                container = document.createElement('div');
                container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
                document.body.appendChild(container);
            }

            // Simple alert fallback if no toast library
            // Since we use custom notification in the previous code, let's try to keep it simple
            // Using standard Bootstrap toast structure or simple custom div
            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show`;
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;

            // Allow styling to position it fixed
            notification.style.position = 'fixed';
            notification.style.bottom = '20px';
            notification.style.right = '20px';
            notification.style.zIndex = '9999';

            document.body.appendChild(notification);

            // Auto-fechar após 5 segundos
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 500);
            }, 5000);
        }
    });
</script>
{% endblock %}
